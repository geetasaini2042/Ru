<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unlock File</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- libtl SDK -->
  <script src="//libtl.com/sdk.js" data-zone="9504493" data-sdk="show_9504493"></script>

  <!-- tads SDK -->
  <script src="https://w.tads.me/widget.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem 1rem;
      min-height: 100vh;
    }
    .container {
      max-width: 420px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 2rem;
    }
    h1 {text-align:center;}
    .btn {
      background:#00ffcc;
      color:#000;
      padding:0.9rem 2rem;
      border:none;
      border-radius:50px;
      font-weight:600;
      width:100%;
      cursor:pointer;
    }
    .loading {display:none;text-align:center;margin-top:1rem;color:#00ffcc;}
    .ad-type {text-align:center;margin-top:10px;font-size:0.85rem;color:#00ffc8b9;}
    .info-box {margin-bottom:1rem;}
  </style>
</head>
<body>
  <div class="container">
    <h1>üîì Unlock File</h1>
    <p>Watch an ad to access your premium file</p>

    <div class="info-box" id="fileDetails"></div>

    <button class="btn" id="watchBtn" onclick="watchAd()">‚ñ∂Ô∏è Watch Ad to Unlock</button>
    <div class="loading" id="loading">‚è≥ Unlocking...</div>
    <div class="ad-type" id="adInfoText">Ad: --</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user || {};
    const userId = user?.id;

    const query = new URLSearchParams(window.location.search);
    const uuid = query.get("uuid");
    const name = query.get("file_name");
    const caption = query.get("file_des");
    const size = query.get("file_size");
    const baseUrl = query.get("url");

    // File info show
    document.getElementById("fileDetails").innerHTML = `
      <b>File:</b> ${decodeURIComponent(name || "-")}<br>
      <b>Description:</b> ${decodeURIComponent(caption || "-")}<br>
      <b>Size:</b> ${decodeURIComponent(size || "-")}
    `;

    // --------- Storage Reset Daily ---------
    function resetDaily() {
      const today = new Date().toISOString().split("T")[0];
      const savedDay = localStorage.getItem("ads_day");
      if (savedDay !== today) {
        localStorage.setItem("ads_day", today);
        localStorage.setItem("ad_counter", "0");
      }
    }
    resetDaily();

    function getAdCounter() {
      return parseInt(localStorage.getItem("ad_counter") || "0", 10);
    }
    function setAdCounter(val) {
      localStorage.setItem("ad_counter", val.toString());
    }

    // --------- Unlock Function ---------
    function sendUnlock() {
      const finalUrl = `${baseUrl}?uuid=${encodeURIComponent(uuid)}&user_id=${encodeURIComponent(userId)}`;
      return fetch(finalUrl);
    }

    // --------- Ad Functions ---------
    const adFunctions = {
      google: () => {
        document.getElementById("adInfoText").innerText = "Ad: Google";
        return new Promise((resolve) => {
          const params = new URLSearchParams({
            uuid: uuid,
            user_id: userId,
            url: baseUrl,
            file_name: name,
            file_des: caption,
            file_size: size
          });
          window.location.href = "https://uor.edumate.life/education-pdfs/?" + params.toString();
          resolve();
        });
      },
      libtl: () => {
        document.getElementById("adInfoText").innerText = "Ad: libtl (Zone 9504493)";
        return show_9504493().then(sendUnlock);
      },
      tads: () => {
        document.getElementById("adInfoText").innerText = "Ad: TADS (Widget 614)";
        return new Promise((resolve, reject) => {
          const controller = window.tads?.init({
            widgetId: "614",
            type: "fullscreen",
            onShowReward: () => {
              sendUnlock().then(resolve).catch(reject);
            },
            onAdsNotFound: reject
          });
          if (controller?.showAd) controller.showAd().catch(reject);
          else reject("‚ùå TADS showAd not ready");
        });
      }
    };

    // --------- Sequence Logic ---------
    function getNextAdType() {
      const counter = getAdCounter();
      let adType;
      if (counter < 2) {
        adType = "google"; // ‡§™‡§π‡§≤‡•á 2 ‡§¨‡§æ‡§∞ Google
      } else {
        const seq = (counter - 2) % 3; 
        if (seq === 0) adType = "libtl";
        if (seq === 1) adType = "tads";
        if (seq === 2) adType = "google";
      }
      setAdCounter(counter + 1);
      return adType;
    }

    // --------- Watch Ad ---------
    function watchAd() {
      if (!uuid || !baseUrl || !userId) {
        alert("‚ùå Missing required data.");
        return;
      }

      const adType = getNextAdType();
      const adFn = adFunctions[adType];

      document.getElementById("watchBtn").disabled = true;
      document.getElementById("loading").style.display = "block";

      adFn()
        .then(() => {
          if (adType !== "google") {
            alert("‚úÖ File unlocked! Check your Telegram.");
            setTimeout(() => tg.close(), 5000);
          }
        })
        .catch((err) => {
          alert("‚ùå Ad failed.");
          console.error(err);
          document.getElementById("loading").style.display = "none";
          document.getElementById("watchBtn").disabled = false;
        });
    }
  </script>
</body>
</html>
